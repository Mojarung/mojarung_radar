# Архитектура проекта RADAR

## Общее описание

RADAR - это сервис поиска и оценки горячих новостей в финансовой сфере, построенный на основе ReAct-архитектуры с использованием LangGraph.

## Технологический стек

- **FastAPI** - веб-фреймворк для создания API
- **LangGraph** - фреймворк для создания агентов на основе графов
- **PostgreSQL** - основная база данных для хранения новостей, сюжетов и метаданных
- **Redis** - кеширование и очереди задач
- **Alembic** - миграции базы данных
- **OpenRouter** - провайдер LLM (с возможностью замены)

## Структура проекта

```
radar/
├── app/
│   ├── main.py                 # Точка входа FastAPI приложения
│   ├── api/                    # API endpoints
│   │   ├── __init__.py
│   │   └── endpoints/
│   │       ├── __init__.py
│   │       ├── news.py         # Endpoints для работы с новостями
│   │       └── health.py       # Health check endpoints
│   ├── core/                   # Базовая конфигурация
│   │   ├── __init__.py
│   │   ├── config.py           # Настройки приложения
│   │   ├── logging.py          # Конфигурация логирования
│   │   └── dependencies.py     # DI зависимости
│   ├── db/                     # База данных
│   │   ├── __init__.py
│   │   ├── session.py          # Подключение к БД
│   │   └── redis.py            # Подключение к Redis
│   ├── models/                 # SQLAlchemy модели
│   │   ├── __init__.py
│   │   ├── news.py             # Модель новости
│   │   ├── story.py            # Модель сюжета (кластера новостей)
│   │   └── source.py           # Модель источника
│   ├── schemas/                # Pydantic схемы
│   │   ├── __init__.py
│   │   ├── news.py             # Схемы для новостей
│   │   └── response.py         # Схемы ответов API
│   ├── llm/                    # LLM провайдеры
│   │   ├── __init__.py
│   │   ├── base.py             # Базовый класс провайдера
│   │   └── openrouter.py       # OpenRouter провайдер
│   ├── graph/                  # LangGraph агент
│   │   ├── __init__.py
│   │   ├── state.py            # Состояние графа
│   │   ├── graph.py            # Определение графа
│   │   └── nodes/              # Узлы графа
│   │       ├── __init__.py
│   │       ├── ingestion.py    # Узел сбора новостей
│   │       ├── deduplication.py # Узел дедупликации
│   │       ├── enrichment.py   # Узел обогащения
│   │       ├── scoring.py      # Узел оценки горячести
│   │       ├── context.py      # Узел сборки контекста (RAG)
│   │       └── draft.py        # Узел генерации черновика
│   └── services/               # Бизнес-логика
│       ├── __init__.py
│       ├── news_service.py     # Сервис работы с новостями
│       └── embeddings.py       # Сервис работы с эмбеддингами
├── alembic/                    # Миграции БД
│   ├── versions/
│   ├── env.py
│   └── script.py.mako
├── docker-compose.yml
├── Dockerfile
├── pyproject.toml
└── README.md
```

## Архитектура агента (LangGraph)

### Состояние графа (State)

Центральный объект, передаваемый между узлами:

- `news_id` - ID новости
- `cluster_id` - ID кластера (сюжета)
- `related_articles` - Связанные статьи
- `entities` - Извлеченные сущности (компании, тикеры)
- `timeline` - Временная шкала событий
- `source_reputation` - Оценка источника
- `hotness_score` - Оценка горячести [0,1]
- `context` - Контекст для генерации
- `draft` - Готовый черновик

### Узлы графа

1. **Ingestion Node** - Прием новостей из внешних источников
2. **Deduplication Node** - Дедупликация через векторное сходство
3. **Enrichment Node** - Извлечение сущностей и метаданных
4. **Scoring Node** - Оценка горячести новости
5. **Context Builder (RAG) Node** - Сборка контекста через RAG
6. **Draft Generator Node** - Генерация черновика публикации

### Логика переходов

```
Ingest → Deduplication
         ↓
    [Новая или существующая?]
         ↓
    Enrichment → Scoring
         ↓
    [hotness_score > порог?]
         ↓
    Context Builder → Draft Generator → Результат
```

## Обработка сценариев

### Мгновенный импульс
Новость сразу получает высокий балл и проходит весь граф за один проход.

### Нарастающий нарратив
Сюжет постепенно накапливает `hotness_score` с каждой новой публикацией, пока не превысит порог.

## База данных

### Основные таблицы

- `news` - Новости
- `stories` - Сюжеты (кластеры новостей)
- `sources` - Источники новостей
- `entities` - Извлеченные сущности
- `news_embeddings` - Векторные представления

## Кеширование

Redis используется для:
- Кеширования результатов API
- Хранения векторов для быстрого поиска
- Очередей задач для асинхронной обработки

## LLM провайдеры

Абстракция провайдера позволяет легко заменить OpenRouter на другой сервис:

```python
class BaseLLMProvider:
    async def generate(self, prompt: str, **kwargs) -> str:
        raise NotImplementedError
```

## Логирование

Структурированное логирование с уровнями:
- DEBUG - детальная отладочная информация
- INFO - основные события системы
- WARNING - предупреждения
- ERROR - ошибки с stacktrace

## Масштабирование

Проект спроектирован с учетом масштабирования:

1. **Горизонтальное масштабирование API** - через load balancer
2. **Асинхронная обработка** - через Redis очереди
3. **Кеширование** - для снижения нагрузки на БД и LLM
4. **Векторный поиск** - для быстрой дедупликации

## Развертывание

Проект запускается через docker-compose:
- Приложение FastAPI
- PostgreSQL база данных
- Redis кеш

Для локальной разработки используется uv с Python 3.12.

