# News Classification System

## Обзор

RADAR использует двухэтапную систему классификации для отбора финансово-релевантных новостей:

1. **Quick Filter** - быстрая фильтрация по ключевым словам
2. **LLM Classification** - точная классификация с помощью языковой модели

## Архитектура

```
Новости РБК
    ↓
Quick Filter (по ключевым словам)
    ↓ (прошли фильтр)
LLM Classification
    ↓ (is_relevant: true)
RabbitMQ Queue → Worker → ClickHouse
```

## Quick Filter

### Ключевые слова

Система проверяет наличие финансовых терминов в заголовке и анонсе:

**Русские термины:**
- Экономика, финансы, банк, инвестиции, акции, биржа
- Валюта, рубль, доллар, евро, ЦБ, Центробанк
- Нефть, газ, золото, металлы, сырье, экспорт, импорт
- Инфляция, ВВП, бюджет, налоги, тарифы
- Криптовалюта, биткоин, блокчейн, майнинг
- Рынок, цена, стоимость, котировки, индекс
- Недвижимость, ипотека, строительство

**Английские термины:**
- economy, finance, bank, investment, stock, market
- currency, dollar, euro, bitcoin, crypto, trading
- merger, acquisition, IPO, fund, bond, dividend

### Преимущества Quick Filter

✅ **Скорость** - проверка занимает микросекунды  
✅ **Экономия** - не вызываем LLM для очевидно нерелевантных статей  
✅ **Покрытие** - широкий список терминов гарантирует, что ничего не пропустим

## LLM Classification

### Как работает

LLM получает заголовок и анонс статьи с детальным промптом:

```python
{
  "is_relevant": true/false,      # Финансово релевантна?
  "confidence": 0.0-1.0,           # Уверенность модели
  "categories": ["категория1"],   # Категории новости
  "reason": "объяснение"          # Почему релевантна/нет
}
```

### Категории

LLM определяет одну или несколько категорий:

- **макроэкономика** - ВВП, инфляция, денежная политика
- **банки** - банковский сектор, кредитование
- **фондовый_рынок** - акции, облигации, IPO
- **криптовалюты** - Bitcoin, альткоины, блокчейн
- **недвижимость** - рынок недвижимости, строительство
- **корпоративные_новости** - отчеты компаний, M&A
- **сырьевые_рынки** - нефть, газ, металлы
- **валютный_рынок** - forex, курсы валют
- **регулирование** - законы, решения регуляторов
- **инвестиции** - инвестфонды, стратегии
- **другое** - прочие финансовые темы

### Что считается релевантным

✅ Экономические показатели (ВВП, инфляция)  
✅ Финансовые рынки (акции, валюты, сырье)  
✅ Компании и бизнес (сделки, результаты)  
✅ Банки и финансовые институты  
✅ Криптовалюты и блокчейн  
✅ Недвижимость как инвестиционный актив  
✅ Торговля и инвестиции  
✅ Экономическая политика и регулирование

### Что НЕ релевантно

❌ Спорт (кроме финансов спортклубов)  
❌ Культура и развлечения  
❌ Общественные события без экономики  
❌ Погода  
❌ Происшествия (кроме влияющих на экономику)  
❌ Личная жизнь знаменитостей

## Парсинг по проектам РБК

### Включенные проекты

Парсятся следующие проекты РБК:

| Проект | Описание | Релевантность |
|--------|----------|---------------|
| `rbcnews` | Основные новости | ⭐⭐⭐ Высокая |
| `quote` | Финансы и рынки | ⭐⭐⭐ Высокая |
| `crypto` | Криптовалюты | ⭐⭐⭐ Высокая |
| `realty` | Недвижимость | ⭐⭐ Средняя |
| `bc3` | Бизнес | ⭐⭐ Средняя |
| `trends` | Тренды | ⭐ Низкая |
| `rbctv` | Видео РБК | ⭐ Низкая |
| `rbcstyle` | Стиль жизни | ⭐ Низкая |

### Исключенные проекты

❌ `sport` - Спорт  
❌ `autonews` - Автомобили

## Настройка

### Включить/выключить классификацию

```python
# src/parsers/scheduler.py
task = self.run_parser(
    parser,
    classify=True  # True = включить, False = отключить
)
```

### Изменить список проектов

```python
# src/parsers/scheduler.py
task = self.run_parser(
    parser,
    projects=["rbcnews", "quote", "crypto"],  # Только эти проекты
)
```

### Настроить порог уверенности

```python
# src/parsers/classifier.py, метод batch_classify
if classification['is_relevant'] and classification['confidence'] > 0.7:
    # Добавить только с высокой уверенностью
    classified.append(article)
```

## Производительность

### Оптимизация

**Quick Filter**:
- ⚡ ~0.001 сек на статью
- Отфильтровывает ~60-70% нерелевантных статей

**LLM Classification**:
- ⏱️ ~1-2 сек на статью
- Вызывается только для прошедших Quick Filter
- Батчинг не используется для точности

### Пример работы

При парсинге 100 статей:
1. Quick Filter: 100 статей → 40 прошли (60 отсеяны)
2. LLM Classification: 40 статей → 25 релевантных
3. **Итог**: 25 релевантных статей вместо 100

**Экономия времени**: ~75% (не вызываем LLM для 60 статей)  
**Экономия средств**: ~75% API запросов к OpenRouter

## Мониторинг

### Логи классификации

```bash
# Логи парсера с классификацией
docker logs radar-parser -f | grep "Classified"

# Пример вывода:
# Classified: 'ЦБ повысил ключевую ставку...' -> relevant=True, confidence=0.95
# Quick-filtered out: Новый сезон сериала...
```

### Статистика в ClickHouse

```sql
-- Статьи по категориям (если сохраняете classification)
SELECT 
    JSONExtractString(classification, 'categories') as category,
    count() as cnt
FROM news_articles
WHERE classification != ''
GROUP BY category
ORDER BY cnt DESC
```

## Best Practices

1. **Используйте Quick Filter** - быстро отсекает 60-70% мусора
2. **Настройте проекты** - парсите только нужные разделы РБК
3. **Мониторьте false negatives** - проверяйте, не пропускаются ли важные новости
4. **Регулярно обновляйте ключевые слова** - добавляйте новые термины
5. **Логируйте примеры** - сохраняйте classification для анализа

## Troubleshooting

### Слишком много нерелевантных новостей

→ Ужесточите Quick Filter или добавьте проверку `confidence > 0.8`

### Пропускаются важные новости

→ Добавьте ключевые слова в Quick Filter или проверьте LLM промпт

### Медленная работа

→ Уменьшите `max_pages` или отключите `include_text=False` для классификации

### Высокая стоимость LLM

→ Добавьте больше ключевых слов в Quick Filter для лучшей предфильтрации

